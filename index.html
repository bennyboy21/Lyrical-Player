<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing Tracker (PKCE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Dark Spotify background */
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 420px;
            background: #1e1e1e; /* Card background */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 1.5rem;
        }
        .spotify-green {
            background-color: #1DB954;
            transition: background-color 0.15s ease;
        }
        .spotify-green:hover {
            background-color: #1ed760;
        }
        .pulse-icon {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
        }
    </style>
</head>
<body>

    <div class="container rounded-xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-white flex items-center justify-center">
            <svg class="w-8 h-8 mr-2" fill="#1DB954" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.111 17.583c-.156.26-.502.348-.762.193a7.35 7.35 0 0 1-8.524-3.558c-.144-.265-.057-.607.208-.751.265-.144.607-.057.751.208a6.11 6.11 0 0 0 7.103 2.96c.26.155.348.502.193.762zm1.61-3.033c-.167.282-.553.388-.836.222a9.773 9.773 0 0 1-11.232-4.664c-.282-.167-.388-.553-.222-.836.167-.282.553-.388.836-.222a8.553 8.553 0 0 0 9.845 4.103c.282.167.388.553.222.836zm.186-4.636c-1.39-2.327-3.92-3.83-6.666-3.83-2.747 0-5.277 1.503-6.667 3.83-.284.168-.672.062-.84-.223-.167-.285-.062-.672.223-.84C6.556 2.5 9.17 1 12 1s5.444 1.5 6.949 3.84c.285.168.39.555.223.84z"/>
            </svg>
            Spotify Tracker
        </h1>

        <!-- Login Section -->
        <div id="login-section" class="mb-6 text-center">
            <p class="text-gray-300 mb-4">Log in to Spotify to start tracking your current song.</p>
            <button id="login-button" class="spotify-green text-black font-bold py-3 px-6 rounded-full w-full shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-300">
                Login with Spotify
            </button>
        </div>

        <!-- Song Status Section -->
        <div id="status-section" class="hidden text-center">
            <div id="status-message" class="text-xl font-semibold mb-4 text-white"></div>
            
            <div id="song-display" class="hidden bg-gray-800 p-4 rounded-lg text-left shadow-inner">
                <img id="album-art" class="w-full h-auto rounded-lg mb-4 shadow-md" alt="Album Art">
                <p class="text-xs text-gray-400 font-medium uppercase tracking-wider">Now Playing</p>
                <h2 id="song-title" class="text-2xl font-bold mt-1 text-white"></h2>
                <p id="artist-name" class="text-lg text-gray-300"></p>
                <p id="album-name" class="text-sm text-gray-400 mt-2"></p>
                <!-- Time Display Added Here -->
                <p id="time-text" class="text-sm text-gray-400 text-right font-mono mt-2 mb-1">0:00 / 0:00</p>
                <!-- End Time Display -->
                <div id="progress-bar-container" class="mt-1 h-1 bg-gray-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full spotify-green transition-all duration-500" style="width: 0%;"></div>
                </div>
            </div>

            <!-- Polling Indicator -->
            <p id="polling-indicator" class="mt-4 text-sm text-gray-500 hidden">
                <span class="inline-block h-3 w-3 rounded-full spotify-green mr-2 pulse-icon"></span>
                Checking for playback...
            </p>
        </div>
    </div>

    <script>
        // --- IMPORTANT: CONFIGURE THESE VALUES ---
        const CLIENT_ID = '86d5980bc6284ccba0515e63ddd32845'; // <<< You must replace this with your Spotify Client ID
        // The REDIRECT_URI MUST be registered exactly in your Spotify Developer App settings.
        const REDIRECT_URI = 'https://bennyboy21.github.io/Lyrical-Player/'; // Updated as requested
        // ------------------------------------------

        const AUTHORIZE_URL = 'https://accounts.spotify.com/authorize';
        const TOKEN_URL = 'https://accounts.spotify.com/api/token';
        const NOW_PLAYING_URL = 'https://api.spotify.com/v1/me/player/currently-playing';
        // This is the correct scope needed to read the currently playing track.
        const SCOPE = 'user-read-currently-playing';

        let accessToken = null;
        let pollingIntervalId = null;
        
        // --- New Variables for Smooth Progress Tracking ---
        let progressUpdaterId = null; // Interval for smooth progress bar update
        let currentTrackId = null;    // ID of the track currently being displayed smoothly
        let progressStartTime = 0;    // Timestamp when the smooth update started
        let initialProgressMs = 0;    // Progress reported by Spotify at progressStartTime
        let trackDurationMs = 0;      // Duration of the current track in ms
        // --------------------------------------------------

        // --- UI Element References ---
        const loginSection = document.getElementById('login-section');
        const statusSection = document.getElementById('status-section');
        const statusMessage = document.getElementById('status-message');
        const songDisplay = document.getElementById('song-display');
        const songTitle = document.getElementById('song-title');
        const artistName = document.getElementById('artist-name');
        const albumName = document.getElementById('album-name');
        const albumArt = document.getElementById('album-art');
        const progressBar = document.getElementById('progress-bar');
        const pollingIndicator = document.getElementById('polling-indicator');
        const timeText = document.getElementById('time-text'); // New UI ref

        // --- Utility Functions ---

        /** Generates a cryptographically secure random string. */
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const randomValues = crypto.getRandomValues(new Uint8Array(length));
            return randomValues.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        /** Base64-URL encodes a buffer. */
        function base64urlencode(buffer) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        /** Creates a SHA256 hash and converts it to a base64 URL-safe string. */
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64urlencode(hash);
        }
        
        /** Converts milliseconds to MM:SS format. */
        function msToTime(ms) {
            if (ms === null || isNaN(ms) || ms < 0) return '0:00';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- Authentication Flow ---

        function redirectToAuthCodeFlow() {
            // Updated check to catch the new placeholder string
            if (CLIENT_ID === 'PASTE_YOUR_CLIENT_ID_HERE') {
                // IMPORTANT: Since alert() is restricted, log to console and set a UI message instead
                console.error('ERROR: Please update CLIENT_ID in the script.');
                document.getElementById('status-message').textContent = 'AUTH ERROR: Please replace the placeholder ID in the script and reload.';
                document.getElementById('status-message').classList.remove('hidden');
                loginSection.classList.add('hidden');
                return;
            }

            // 1. Create and store a code verifier
            const codeVerifier = generateRandomString(128);
            localStorage.setItem('code_verifier', codeVerifier);
            console.log("Requested Spotify Scope:", SCOPE); // Log scope for debugging

            // 2. Hash the code verifier to get the code challenge
            sha256(codeVerifier).then(codeChallenge => {
                const params = new URLSearchParams({
                    response_type: 'code',
                    client_id: CLIENT_ID,
                    scope: SCOPE,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    redirect_uri: REDIRECT_URI,
                });

                // 3. Redirect the user to the Spotify authorization page
                window.location.href = `${AUTHORIZE_URL}?${params.toString()}`;
            }).catch(e => {
                console.error("Error generating code challenge:", e);
            });
        }

        async function getAccessToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            if (!codeVerifier) {
                console.error("Code verifier not found.");
                return null;
            }
            
            // Clear verifier after use
            localStorage.removeItem('code_verifier'); 

            const params = new URLSearchParams({
                client_id: CLIENT_ID,
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: REDIRECT_URI,
                code_verifier: codeVerifier,
            });

            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString(),
                });

                if (!response.ok) {
                    throw new Error(`Token request failed with status: ${response.status}`);
                }

                const data = await response.json();
                
                return data.access_token;
            } catch (error) {
                console.error('Error fetching access token:', error);
                return null;
            }
        }

        // --- Spotify API Interaction ---

        /** Fetches the currently playing song from Spotify. */
        async function fetchCurrentlyPlaying() {
            try {
                const response = await fetch(NOW_PLAYING_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 204) {
                    // 204 No Content: Nothing is playing or no active device
                    return null;
                }

                if (!response.ok) {
                    const errorDetails = await response.text().catch(() => response.statusText);
                    
                    if (response.status === 401) {
                        console.error("Access Token expired or invalid. Attempting re-login.");
                        // Redirect to restart the auth flow
                        setTimeout(() => {
                           window.location.href = REDIRECT_URI;
                        }, 100);
                        return null;
                    } 
                    
                    if (response.status === 403) {
                         // Specific guidance for 403 error
                         console.error(`API Error 403 (Forbidden): The token is valid but lacks permission. Details: ${errorDetails}`);
                         statusMessage.textContent = `403 FORBIDDEN: Please ensure the Spotify account you logged in with is added as a 'User' in your app's 'Users and Access' settings in the Spotify Developer Dashboard.`;
                         throw new Error(`API Error 403 Forbidden: Missing scope or account whitelisting issue.`);
                    }

                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                return await response.json();

            } catch (error) {
                console.error('Error fetching currently playing track:', error);
                // Stop polling on critical errors
                if (!error.message.includes('403')) {
                    clearInterval(pollingIntervalId);
                    pollingIndicator.classList.add('hidden');
                    statusMessage.textContent = 'A critical network or API error occurred. Check console.';
                }
                return null;
            }
        }
        
        /**
         * Runs every 500ms to smoothly update the progress bar and time text
         * based on the initial Spotify progress and local elapsed time.
         */
        function smoothUpdateProgress() {
            const elapsedTime = Date.now() - progressStartTime;
            let currentProgressMs = initialProgressMs + elapsedTime;

            // Cap the progress at the track duration
            if (currentProgressMs > trackDurationMs) {
                currentProgressMs = trackDurationMs;
                clearInterval(progressUpdaterId);
                progressUpdaterId = null;
                // Wait for the next 5s poll to detect track change/end
            }

            const progressPercent = (currentProgressMs / trackDurationMs) * 100;
            
            // Update UI
            progressBar.style.width = `${progressPercent}%`;
            timeText.textContent = `${msToTime(currentProgressMs)} / ${msToTime(trackDurationMs)}`;
        }


        /** Main logic to poll for the currently playing song every 5 seconds. */
        function pollForSong() {
            // Show status and hide login
            loginSection.classList.add('hidden');
            statusSection.classList.remove('hidden');
            pollingIndicator.classList.remove('hidden');
            
            // Set initial status message
            if (!statusMessage.textContent.includes('FORBIDDEN')) {
                 statusMessage.textContent = 'Waiting for you to start playing music...';
            }


            pollingIntervalId = setInterval(async () => {
                const data = await fetchCurrentlyPlaying();
                
                if (data && data.is_playing) {
                    // --- Case 1: Song is actively playing ---
                    const track = data.item;
                    
                    // A. Check if this is a NEW track or if the smooth updater is not running
                    if (track.id !== currentTrackId || progressUpdaterId === null) {
                        
                        console.log('New track detected or resumed. Starting smooth update.');
                        
                        // Clear old smooth interval if exists
                        if (progressUpdaterId) clearInterval(progressUpdaterId);

                        // Update metadata
                        const artistText = track.artists.map(a => a.name).join(', ');
                        songTitle.textContent = track.name;
                        artistName.textContent = artistText;
                        albumName.textContent = track.album.name;
                        albumArt.src = track.album.images[0]?.url || 'https://placehold.co/400x400/1DB954/ffffff?text=No+Art';
                        
                        // Initialize smooth update variables
                        currentTrackId = track.id;
                        initialProgressMs = data.progress_ms;
                        trackDurationMs = track.duration_ms;
                        progressStartTime = Date.now();
                        
                        // Start the smooth update interval (runs every 500ms)
                        progressUpdaterId = setInterval(smoothUpdateProgress, 500);

                        // Initial manual update to ensure immediate display
                        smoothUpdateProgress();
                        
                        // Update UI visibility
                        statusMessage.textContent = 'Currently Playing:';
                        statusMessage.classList.remove('hidden');
                        songDisplay.classList.remove('hidden');
                        pollingIndicator.classList.add('hidden');
                        
                    } else if (track.id === currentTrackId) {
                        // B. Same track is playing: Check for seeking (progress jump)
                        
                        const expectedProgressMs = initialProgressMs + (Date.now() - progressStartTime);
                        const reportedProgressMs = data.progress_ms;
                        const diff = Math.abs(expectedProgressMs - reportedProgressMs);
                        
                        // Re-sync if the reported position is off by more than 2 seconds (user seeked)
                        if (diff > 2000) {
                            console.log('Seek detected! Re-syncing progress.');
                            initialProgressMs = reportedProgressMs;
                            progressStartTime = Date.now();
                        }
                    }

                } else {
                    // --- Case 2: Nothing playing or music is paused (204 or is_playing=false) ---
                    
                    // Stop the smooth progress interval
                    if (progressUpdaterId) {
                        clearInterval(progressUpdaterId);
                        progressUpdaterId = null;
                    }
                    currentTrackId = null;
                    
                    // Check if music is paused
                    if (data && !data.is_playing && data.item) {
                        const artistText = data.item.artists.map(a => a.name).join(', ');
                        statusMessage.textContent = `Music is paused: ${data.item.name} by ${artistText}`;
                        songDisplay.classList.add('hidden');
                    } else if (!statusMessage.textContent.includes('FORBIDDEN')) {
                        // Or no playback found (204)
                        statusMessage.textContent = 'Waiting for you to start playing music...';
                        songDisplay.classList.add('hidden');
                    }
                    
                    statusMessage.classList.remove('hidden');
                    pollingIndicator.classList.remove('hidden');
                }

            }, 5000); // Main state check every 5 seconds
        }

        // --- Main Initialization ---

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            // Clear any existing intervals on fresh load
            if (pollingIntervalId) clearInterval(pollingIntervalId);
            if (progressUpdaterId) clearInterval(progressUpdaterId);

            if (code) {
                // PHASE 2: Callback from Spotify. Exchange the code for an Access Token.
                statusSection.classList.remove('hidden');
                statusMessage.textContent = 'Authenticating...';
                loginSection.classList.add('hidden');

                // Clear the URL to remove the sensitive code parameter
                history.replaceState(null, '', REDIRECT_URI); 

                accessToken = await getAccessToken(code);
                
                if (accessToken) {
                    console.log("Successfully retrieved access token. Starting playback poll.");
                    pollForSong();
                } else {
                    statusMessage.textContent = 'Authentication failed (Token exchange error). Check console.';
                    loginSection.classList.remove('hidden');
                }

            } else {
                // PHASE 1: Initial load. Check if we have an existing token or need to log in.
                loginSection.classList.remove('hidden');
                document.getElementById('login-button').addEventListener('click', redirectToAuthCodeFlow);
            }
        }

        // Run the main function on page load
        init();
    </script>
</body>
</html>
