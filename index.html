<!DOCTYPE html>
<html>
<head>
  <title>Spotify Lyrics Viewer</title>
</head>
<body>
  <button id="login">Login with Spotify</button>
  <h2 id="track"></h2>
  <pre id="lyrics"></pre>

  <script>
    const clientId = "86d5980bc6284ccba0515e63ddd32845"; // from Spotify dashboard
    const redirectUri = window.location.origin; // GitHub Pages site URL
    const scopes = "user-read-currently-playing user-read-playback-state";

    // Generate random string for PKCE
    function generateRandomString(length) {
      let text = "";
      let possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }

    // SHA256 helper
    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return window.crypto.subtle.digest("SHA-256", data);
    }

    function base64urlencode(a) {
      let str = "";
      const bytes = new Uint8Array(a);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        str += String.fromCharCode(bytes[i]);
      }
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function generateCodeChallenge(codeVerifier) {
      const hashed = await sha256(codeVerifier);
      return base64urlencode(hashed);
    }

    const loginBtn = document.getElementById("login");
    loginBtn.addEventListener("click", async () => {
      const codeVerifier = generateRandomString(128);
      const codeChallenge = await generateCodeChallenge(codeVerifier);

      localStorage.setItem("code_verifier", codeVerifier);

      const args = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        scope: scopes,
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: codeChallenge,
      });

      window.location = "https://accounts.spotify.com/authorize?" + args;
    });

    async function getAccessToken(code) {
      const codeVerifier = localStorage.getItem("code_verifier");

      const body = new URLSearchParams({
        client_id: clientId,
        grant_type: "authorization_code",
        code: code,
        redirect_uri: redirectUri,
        code_verifier: codeVerifier,
      });

      const response = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body,
      });

      return response.json();
    }

    async function getCurrentTrack(token) {
      const response = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers: { Authorization: "Bearer " + token },
      });
      if (response.status === 204) return null;
      return response.json();
    }

    window.onload = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");

      if (code) {
        const tokenResponse = await getAccessToken(code);
        const accessToken = tokenResponse.access_token;

        setInterval(async () => {
          const trackData = await getCurrentTrack(accessToken);
          if (trackData && trackData.item) {
            document.getElementById("track").innerText =
              trackData.item.name + " - " + trackData.item.artists[0].name;

            // TODO: Call Genius API here for lyrics
            document.getElementById("lyrics").innerText =
              "Lyrics for: " +
              trackData.item.name +
              " by " +
              trackData.item.artists[0].name;
          }
        }, 5000);
      }
    };
  </script>
</body>
</html>
